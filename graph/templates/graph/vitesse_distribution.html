{% extends "base.html" %}
{% csrf_token %}
{% load static %}
{% block content %}
<h1>Distribution des vitesses</h1>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{{ refresh_interval|default:"25000"|json_script:"refresh_interval" }}
    {{ total_count|default:"0"|json_script:"total_count" }}
    {{ loaded_count|default:"0"|json_script:"loaded_count" }}
    {{ min_distance|default:"5000"|json_script:"min_distance" }}
    {{ max_distance|default:"10000"|json_script:"max_distance" }}
    {{ type_list|default:"['Course sur route', 'Foulee']"|json_script:"type_list" }}
    {{ stats|default:"[]"|json_script:"stats" }}
        {{ categories|default:"['F','M']"|json_script:"categories" }}
            {{ series_categories|json_script:"series_categories" }}
    {{ is_update|default:False|json_script:"is_update" }}
<div style="display: none;">
    <span id="refresh_interval">{{ refresh_interval|default:"25000" }}</span>
    <span id="total_count">{{ total_count|default:"0" }}</span>
    <span id="loaded_count">{{ loaded_count|default:"0" }}</span>
    <span id="min_distance">{{ min_distance|default:"5000" }}</span>
    <span id="max_distance">{{ max_distance|default:"10000"}}</span>
    <span id="type_list">{{ type_list|default:"['Course sur route', 'Foulee']"|safe}}</span>
        <span id="categories">{{ type_list|default:"['F', 'M']"|safe}}</span>
            <span id="series_categories">{{ type_list|safe}}</span>
    <span id="stats">{{ stats|default:"[]"|safe}}</span>
</div>
<script>
window.isRefreshing = false;
</script>
<script src="{% static 'js/chartConfig.js' %}"></script>
    <button id="categorieSimplifieeButton">
        <!-- Texte initial basé sur le mode -->
        Passer en mode Catégories Simplifiées
    </button>
<div id="course-types">
  <label>
    <input type="checkbox" name="course-type" value="Foulee" checked> Foulée
  </label>
  <label>
    <input type="checkbox" name="course-type" value="Course sur route" checked> Course sur route
  </label>
  <label>
    <input type="checkbox" name="course-type" value="Cross"> Cross
  </label>
  <label>
    <input type="checkbox" name="course-type" value="Triathlon"> Triathlon
  </label>
  <label>
    <input type="checkbox" name="course-type" value="Trail"> Trail
  </label>
    </div>
<div id="select_categorie" class="majorone">
    <div id="all_categorie" class="category-container" data-categories="{{ categories_json|safe }}">
    </div>
    <div id="categorie_selected" class="group-of-category-container">
        <div id="buttonsdiv" class="buttondiv">
            <div id="bouton+" class="control-button">
                <button>Ajouter une série</button>
            </div>
            <div id="bouton-" class="control-button">
                <button>Supprimer une série</button>
            </div>
        </div>
        <div id="series_container" class="series-wrapper">
            <!-- Les séries seront ajoutées ici -->
        </div>
    </div>
</div>

        <script src="{% static 'js/dragAndDrop.js' %}"></script>
<script src="{% static 'js/createDeleteSeries.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const checkboxes = document.querySelectorAll('#course-types input[type="checkbox"]');
      const fouleeCheckbox = document.querySelector('input[value="Foulée"]');
      const routeCheckbox = document.querySelector('input[value="Course sur route"]');

      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const checkedBoxes = document.querySelectorAll('#course-types input[type="checkbox"]:checked');

          if (checkedBoxes.length > 2) {
            this.checked = false;
          } else if (checkedBoxes.length === 2) {
            if (!(fouleeCheckbox.checked && routeCheckbox.checked)) {
              this.checked = false;
            }
          }

          checkboxes.forEach(cb => {
            if (cb !== fouleeCheckbox && cb !== routeCheckbox) {
              cb.disabled = fouleeCheckbox.checked && routeCheckbox.checked;
            }
          });
          // Mettre à jour chartConfig.typeList
          window.chartConfig.typeList = Array.from(document.querySelectorAll('#course-types input[type="checkbox"]:checked')).map(cb => cb.value);
        });
      });
    });

</script>

<script src="{% static 'plotly.js-dist/plotly.js' %}"></script>
      <script src="{% static 'js/updateCountdown.js' %}"></script>
        <script src="{% static 'js/updateStats.js' %}"></script>

<div class="range-container" style="width: 50%; margin: 20px auto;">
      <link rel="stylesheet" href="{% static 'css/nouislider.min.css' %}">
  <script src="{% static 'js/nouislider.min.js' %}"></script>
  <div id="slider"></div>
  <div id="slider-values">5 km - 10 km</div>
  <button id="submit-filter">Appliquer le filtre</button>
</div>
<script>
function resetContainer() {
  const container = document.getElementById('chart-container');
  const progressinfo = document.getElementById('progress-info');
  const countdown = document.getElementById('countdown');

  if (container) {
    container.innerHTML = '';
  }
  if (progressinfo) {
    progressinfo.innerHTML = '';
  }
  if (countdown) {
    countdown.innerHTML = '';
  }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var slider = document.getElementById('slider');
  var sliderValues = document.getElementById('slider-values');

  noUiSlider.create(slider, {
    start: [5, 10],
    connect: true,
    range: {
      'min': 900,
      'max': 60000
    },
    step: 100,
    format: {
      to: function(value) {
        return Math.round(value / 1000 * 10) / 10 + ' km';
      },
      from: function(value) {
        return value.replace(' km', '') * 1000;
      }
    }
  });

  slider.noUiSlider.on('update', function(values) {
    sliderValues.innerHTML = values.join(' - ');
  });
});
</script>

<script>
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    // Extraire les données du DOM
      const loadedCountElement = document.getElementById('loaded-count');
      const totalCountElement = document.getElementById('total-count');
      const refreshIntervalElement = document.getElementById('refresh-interval');
      const typeListElement = document.getElementById('type-list');

      // Mettre à jour window.chartConfig
      window.chartConfig = {
        loadedCount: loadedCountElement ? parseInt(loadedCountElement.textContent) : 0,
        totalCount: totalCountElement ? parseInt(totalCountElement.textContent) : 0,
        refreshInterval: refreshIntervalElement ? parseInt(refreshIntervalElement.textContent) : 0,
        typeList: typeListElement ? JSON.parse(typeListElement.textContent) : [],
        seriesCategories: updateSeriesCategories('series_categories')
      };

      console.log('window.chartConfig:', window.chartConfig);
  });
});
</script>
    <script>
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

    </script>
<script>
document.getElementById('submit-filter').addEventListener('click', function() {
    console.log('Bouton submit-filter cliqué');
    window.isRefreshing = true;

    var values = slider.noUiSlider.get();
    var minDistance = parseFloat(values[0]) * 1000;
    var maxDistance = parseFloat(values[1]) * 1000;
    var selectcategories = window.chartConfig.seriesCategories;
    window.chartConfig.minDistance = minDistance;
    window.chartConfig.maxDistance = maxDistance;

    console.log('Valeurs du slider:', minDistance, maxDistance);
    console.log('Catégories sélectionnées:', selectcategories);

    var typeList = Array.isArray(window.chartConfig.typeList)
        ? window.chartConfig.typeList
        : [window.chartConfig.typeList];

    var selectedCourseTypes = Array.isArray(window.chartConfig.typeList)
        ? window.chartConfig.typeList
        : [window.chartConfig.typeList];

    console.log('Types de courses sélectionnés:', selectedCourseTypes);

    var postData = {
        min_distance: minDistance,
        max_distance: maxDistance,
        course_types: selectedCourseTypes.join(','),
        action: 'submit',
        seriesCategories: window.chartConfig.seriesCategories || {}
    };

    console.log('Données à envoyer:', postData);

    const jsonData = JSON.stringify(postData);
    console.log('Données JSON:', jsonData);

    // Récupérer le jeton CSRF
    let csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrftoken) {
        csrftoken = getCookie('csrftoken');
    }

    if (!csrftoken) {
        console.error('CSRF token not found. Request may fail.');
    }

    fetch('/graph/vitesse-distribution/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: jsonData
    })
.then(response => {
    if (!response.ok) {
        throw new Error('Network response was not ok');
    }
    return response.json(); // Changez ici pour récupérer les données JSON
})
.then(data => { // data contiendra l'objet JSON
    if (data.html) {
        console.log('HTML reçu');
        resetContainer();
        document.getElementById('global').innerHTML = data.html;

      // Exécuter les scripts inclus dans le HTML
      const scripts = document.getElementById('chart-container').querySelectorAll('script');
      scripts.forEach(script => {
        const newScript = document.createElement('script');
        newScript.textContent = script.textContent;
        document.body.appendChild(newScript);
      });

      // Extraire les données du DOM
      const loadedCountElement = document.getElementById('loaded-count');
      const totalCountElement = document.getElementById('total-count');

      // Mettre à jour window.chartConfig
      window.chartConfig.loadedCount = parseInt(loadedCountElement.textContent)
      window.chartConfig.totalCount = parseInt(totalCountElement.textContent)
      // Mettre à jour window.chartConfig avec les données reçues
      window.chartConfig.stats = data.chartData.stats; // Récupérer les stats depuis data.chartData
      if (data.chartData.stats) {
        generateStatsDivs(data.chartData.stats);
        updateStatistics(window.chartConfig.stats); // Mettre à jour les statistiques
        console.log('submitting new stat')
        }


      console.log('window.chartConfig:', window.chartConfig);

      // Relancer le compte à rebours
      const countdownElement = document.getElementById('countdown');
      if (countdownElement) {
        countdownElement.innerHTML = '';
        updateCountdown({
          countdown: Math.floor(window.chartConfig.refreshInterval / 1000),
          message: "Prochaine mise à jour dans {seconds} secondes"
        }, countdownElement, postUpdates);
      }
    } else {
      console.error('Unexpected response format');
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
  })
  .finally(() => {
    console.log('Requête terminée');
    window.isRefreshing = false;
  });
});
</script>

    <div id="global" style="width: 100%; height: 620px;">
    {% include 'graph/partial_vitesse_distribution.html' %}
</div>


{% endblock %}
